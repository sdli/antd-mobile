{"version":3,"sources":["../../api/lib/protoBufTools.js"],"names":["http","require","path","protoBuf","ProtoBuffTools","reqProtoMessageName","method","data","config","new","target","options","host","hostname","port","apiPort","domain","headers","authorization","prototype","createReqBuff","root","AwesomeMessage","lookup","package","dataTable","message","create","buffer","encode","finish","e","console","log","protoBufferStart","func","protoBuffer","reqPromise","Promise","resolve","reject","load","filePath","err","reqBuffer","Object","assign","body","reqHttps","request","resHttps","status","statusCode","fileroot","on","write","end","then","receiveMsg","protoReqList","decode","returnObj","toObject","enums","String","longs","bytes","defaults","arrays","objects","oneofs","protoBufferMulti","InitArr","Initfunc","arr","protoMultiStart","obj","protoPromise","tempData","length","splice","newObj","protoBufferExports","singleRequest","multiRequests","init","module","exports"],"mappings":"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","file":"protoBufTools.js","sourcesContent":["var http = require(\"http\");\r\nvar path = require(\"path\");\r\nvar protoBuf = require(\"protobufjs\");\r\n\r\nvar ProtoBuffTools = function(reqProtoMessageName,method,data,config){\r\n    //test new declaration\r\n    if(!new.target) throw \"protoBuffTolls must have [new] declaration!\";\r\n    \r\n    //constructor\r\n    this.method = method;\r\n    this.data = data;\r\n    this.options = {\r\n        host: config.hostname,\r\n        port: config.apiPort,\r\n        path: (typeof config.domain === \"undefined\")?\r\n              \"http://\"+config.hostname+config.apiPort+\"/\"+reqProtoMessageName\r\n              :config.domain,\r\n        method: method,\r\n        headers: {\r\n            \"Content-Type\": \"application/x-protobuf\",\r\n            \"Authorization\": config.authorization\r\n        },\r\n    };\r\n}\r\n\r\nProtoBuffTools.prototype.createReqBuff = function(reqProtoMessageName,root,config){\r\n    var AwesomeMessage = root.lookup(config.package+\".\"+reqProtoMessageName);  \r\n    var dataTable= this.data;\r\n    try{\r\n        var message = AwesomeMessage.create(dataTable);  \r\n        var buffer = AwesomeMessage.encode(message).finish();\r\n    }catch(e){\r\n        if(e) {\r\n            console.log(e);\r\n        }\r\n    }\r\n    return buffer;\r\n}\r\n\r\nvar protoBufferStart = function(reqProtoMessageName,method,data,func){\r\n    var config = this.config;\r\n    var protoBuffer = new ProtoBuffTools(reqProtoMessageName,method,data,config);\r\n    var reqPromise = new Promise(function(resolve,reject){\r\n        protoBuf.load(config.filePath,function(err,root){\r\n            if (err) throw err;\r\n            var reqBuffer = protoBuffer.createReqBuff(reqProtoMessageName,root,config);\r\n            var options = Object.assign(\r\n                protoBuffer.options,\r\n                {\r\n                    body:reqBuffer\r\n                }\r\n            );\r\n            var reqHttps = http.request(options, function(resHttps) {\r\n                var status = resHttps.statusCode;\r\n                var fileroot = root;\r\n                if(status == 200){\r\n                    resHttps.on('data', function(buffer){\r\n                        resolve({buffer,fileroot,reqProtoMessageName});\r\n                    });\r\n                }else{\r\n                    reject();\r\n                }\r\n            });\r\n            reqHttps.write(reqBuffer);\r\n            reqHttps.end();\r\n            reqHttps.on('error', function(e) {\r\n                return \"系统异常：\"+e.message;\r\n            });\r\n        });\r\n    });\r\n\r\n    reqPromise.then(function({buffer,fileroot,reqProtoMessageName}){\r\n        var receiveMsg = fileroot.lookup(config.package+\".\"+config.protoReqList[reqProtoMessageName]);\r\n        var message = receiveMsg.decode(buffer);\r\n        var returnObj = receiveMsg.toObject(message, {\r\n                enums: String,  // enums as string names\r\n                longs: String,  // longs as strings (requires long.js)\r\n                bytes: String,  // bytes as base64 encoded strings\r\n                defaults: true, // includes default values\r\n                arrays: true,   // populates empty arrays (repeated fields) even if defaults=false\r\n                objects: true,  // populates empty objects (map fields) even if defaults=false\r\n                oneofs: true    // includes virtual oneof fields set to the present field's name\r\n        });\r\n        func(returnObj);\r\n    },function(){\r\n        throw \"promise rejected\";\r\n    });\r\n}\r\n\r\n\r\nvar protoBufferMulti = function(InitArr,Initfunc){\r\n    var arr = InitArr;\r\n    var func = Initfunc;\r\n    var config = this.config;\r\n    protoBuf.load(config.filePath,function(err,root){\r\n        if (err) throw err;\r\n        var protoMultiStart = function(arr,obj={}){\r\n            var protoPromise = new Promise(function(resolve,reject){\r\n                var tempData = arr[0];\r\n                if(arr.length >= 1) arr.splice(0,1);\r\n                var reqProtoMessageName = tempData.reqProtoMessageName;\r\n                var protoBuffer = new ProtoBuffTools(reqProtoMessageName,tempData.method,tempData.data,config);\r\n                var reqBuffer = protoBuffer.createReqBuff(reqProtoMessageName,root,config);\r\n                var options = Object.assign(\r\n                    protoBuffer.options,\r\n                    {\r\n                        body:reqBuffer\r\n                    }\r\n                );\r\n                var reqHttps = http.request(options, function(resHttps) {\r\n                    var status = resHttps.statusCode;\r\n                    var fileroot = root;\r\n                    if(status == 200){\r\n                        resHttps.on('data', function(buffer){\r\n                            resolve({buffer,fileroot,reqProtoMessageName,arr,obj});\r\n                        });\r\n                    }else{\r\n                        reject();\r\n                    }\r\n                });\r\n                reqHttps.write(reqBuffer);\r\n                reqHttps.end();\r\n                reqHttps.on('error', function(e) {\r\n                    return \"系统异常：\"+e.message;\r\n                });\r\n            });\r\n\r\n            protoPromise.then(function({buffer,fileroot,reqProtoMessageName,arr,obj}){\r\n                var receiveMsg = fileroot.lookup(config.package+\".\"+config.protoReqList[reqProtoMessageName]);\r\n                var message = receiveMsg.decode(buffer);\r\n                var returnObj = receiveMsg.toObject(message, {\r\n                        enums: String,  // enums as string names\r\n                        longs: String,  // longs as strings (requires long.js)\r\n                        bytes: String,  // bytes as base64 encoded strings\r\n                        defaults: true, // includes default values\r\n                        arrays: true,   // populates empty arrays (repeated fields) even if defaults=false\r\n                        objects: true,  // populates empty objects (map fields) even if defaults=false\r\n                        oneofs: true    // includes virtual oneof fields set to the present field's name\r\n                });\r\n                var newObj = Object.assign(obj,{\r\n                        [reqProtoMessageName]: returnObj\r\n                });\r\n                if(arr.length >= 1){\r\n                    protoMultiStart(arr,newObj);\r\n                }else{\r\n                    func(newObj);\r\n                }\r\n            },function(){\r\n                throw \"promise rejected\";\r\n            });\r\n        }\r\n\r\n        protoMultiStart(arr,{});\r\n    });\r\n}\r\n\r\nvar protoBufferExports = {\r\n    singleRequest: protoBufferStart,\r\n    multiRequests: protoBufferMulti,\r\n    config: {},\r\n    init:function(obj){\r\n        if(typeof obj !== \"undefined\"){\r\n            this.config = obj;\r\n        } else{\r\n            throw \"init param must be Object\";\r\n        }\r\n    }\r\n}\r\n\r\nmodule.exports = protoBufferExports;"]}